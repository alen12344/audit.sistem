<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ project }} - Alen Audit Sistem Informasi</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:#0b1020; color:#e9eefc;}
    header{padding:24px 20px; background:linear-gradient(120deg,#111a3a,#0b1020); border-bottom:1px solid rgba(255,255,255,.08);}
    h1{margin:0;font-size:22px}
    .meta{opacity:.85; margin-top:6px; font-size:13px}
    .wrap{padding:18px 20px; max-width:1100px; margin:0 auto;}
    .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:14px;}
    .card{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px 14px;}
    .kpi{font-size:26px; font-weight:700}
    .muted{opacity:.8}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top}
    th{text-align:left; opacity:.85}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.14)}
    .sev-critical{background:rgba(255,60,80,.20)}
    .sev-high{background:rgba(255,140,0,.18)}
    .sev-medium{background:rgba(255,220,0,.14)}
    .sev-low{background:rgba(140,220,255,.12)}
    .sev-info{background:rgba(200,200,200,.10)}
    .heat{display:grid; gap:8px}
    .heat .row{display:grid; grid-template-columns: 90px repeat({{ heat_cols|length }}, 1fr); gap:8px; align-items:stretch}
    .cell{border-radius:12px; padding:10px 10px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04)}
    .none{opacity:.55}
    .low{background:rgba(140,220,255,.10)}
    .medium{background:rgba(255,220,0,.10)}
    .high{background:rgba(255,140,0,.12)}
    .very-high{background:rgba(255,60,80,.16)}
    .footer{padding:14px 20px; opacity:.7; font-size:12px}
    .eye{font-size:18px}
  </style>
</head>
<body>
<header>
  <h1><span class="eye">üëÅÔ∏è</span> {{ project }} ‚Äî Alen Audit Sistem Informasi</h1>
  <div class="meta">Owner: <b>{{ owner }}</b> ¬∑ Target: <b>{{ target }}</b> ¬∑ Generated: <b>{{ generated_at }}</b></div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card" style="grid-column: span 3;">
      <div class="muted">Total Findings</div>
      <div class="kpi">{{ kpi.total }}</div>
      <div class="muted">aktif (setelah suppress): {{ kpi.active }}</div>
    </div>
    <div class="card" style="grid-column: span 3;">
      <div class="muted">Critical / High</div>
      <div class="kpi">{{ kpi.critical }} / {{ kpi.high }}</div>
      <div class="muted">Medium / Low: {{ kpi.medium }} / {{ kpi.low }}</div>
    </div>
    <div class="card" style="grid-column: span 6;">
      <div class="muted">OWASP Top 10 (auto mapping)</div>
      <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px">
        {% for k,v in owasp_counts.items() %}
          <span class="pill">{{ k }}: <b>{{ v }}</b></span>
        {% endfor %}
      </div>
    </div>

    <div class="card" style="grid-column: span 6;">
      <h3 style="margin:0 0 10px 0;">Dashboard</h3>
      <canvas id="sevChart" height="120"></canvas>
      <div style="height:12px"></div>
      <canvas id="catChart" height="120"></canvas>
    </div>

    <div class="card" style="grid-column: span 6;">
      <h3 style="margin:0 0 10px 0;">Compliance Heatmap</h3>
      <div class="heat">
        <div class="row">
          <div class="cell muted">Framework</div>
          {% for c in heat_cols %}
            <div class="cell muted" style="text-align:center"><b>{{ c }}</b></div>
          {% endfor %}
        </div>
        {% for row in heat_rows %}
          <div class="row">
            <div class="cell"><b>{{ row.name }}</b><div class="muted" style="font-size:12px">{{ row.desc }}</div></div>
            {% for col in heat_cols %}
              {% set cell = row.cells[col] %}
              <div class="cell {{ cell.level }} {% if cell.level == 'none' %}none{% endif %}">
                <div class="muted" style="font-size:12px">{{ cell.label }}</div>
                <div style="font-size:18px; font-weight:700">{{ cell.count }}</div>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
      <div class="muted" style="margin-top:10px; font-size:12px">
        Skor heatmap dihitung dari bobot severity (info=0..critical=4) via mapping OWASP‚Üícontrol.
      </div>
    </div>

    <div class="card" style="grid-column: span 12;">
      <h3 style="margin:0 0 10px 0;">Findings</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Severity</th><th>Title</th><th>Location</th><th>CWE</th><th>OWASP</th><th>Status</th><th>Suppressed by</th>
          </tr>
        </thead>
        <tbody>
        {% for f in findings %}
          <tr>
            <td><code>{{ f.id }}</code></td>
            <td><span class="pill sev-{{ f.severity }}">{{ f.severity|upper }}</span></td>
            <td><b>{{ f.title }}</b><div class="muted">{{ f.tags|join(', ') }}</div></td>
            <td><code>{{ f.location }}</code></td>
            <td><code>{{ f.cwe or '' }}</code></td>
            <td class="muted">{{ (f.owasp or [])|join('<br/>')|safe }}</td>
            <td class="muted">{{ f.status }}</td>
            <td class="muted">{{ f.suppressed_by or '' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <div class="muted" style="margin-top:10px; font-size:12px">Detail tersimpan di summary.json.</div>
    </div>
  </div>
</div>

<div class="footer">
  Generated by <b>alen-audit-si</b> ¬∑ Defensive audit toolkit ¬∑ MIT
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const sevData = {{ chart.severity | tojson }};
const catData = {{ chart.category | tojson }};

new Chart(document.getElementById('sevChart'), {
  type: 'doughnut',
  data: { labels: sevData.labels, datasets: [{ data: sevData.values }] },
  options: { plugins: { legend: { labels: { color: '#e9eefc' }}}}
});

new Chart(document.getElementById('catChart'), {
  type: 'bar',
  data: { labels: catData.labels, datasets: [{ data: catData.values }] },
  options: {
    scales: { x: { ticks: { color:'#e9eefc' }}, y: { ticks: { color:'#e9eefc' } } },
    plugins: { legend: { display:false } }
  }
});
</script>
</body>
</html>
